var EofyControllerJS=new Class.create();EofyControllerJS.prototype={listDivId:"",pagination:{pageSize:30,pageNumber:1},callbackIds:{},preFixAttachmentID:"attachments_",initialize:function(b,c,a){this.listDivId=b;this.callbackIds.saveEOFYBtn=c;this.callbackIds.delEOFYBtn=a},_getRowDiv:function(b,a){return new Element("div").insert({bottom:new Element("span",{"class":"title"}).update(b)}).insert({bottom:new Element("span",{"class":"item"}).update(a)})},_getEOFYDiv:function(b){var a={};a.me=this;a.eofyId=a.eofyStart=a.eofyEnd=a.eofyComments="";a.assets=[];if(b){console.debug(b);a.eofyId=(b.id||"");a.eofyStart=(b.start||"");a.eofyEnd=(b.end||"");a.eofyComments=(b.comments||"");a.assets=(b.assets||[])}a.attachmentDivID=a.me.preFixAttachmentID+a.eofyId;a.div=new Element("div",{"class":"editDiv row roundcorner",eofyid:a.eofyId,id:"editDiv_"+a.eofyId}).insert({bottom:new Element("div").insert({bottom:new Element("span",{"class":"inlineblock half"}).update(a.me._getRowDiv("Start:",new Element("input",{"class":"inputbox roundcorner datepicker",editdiv:"starttime",hour:"00:00:00",placeholder:"Start of the financial year",readonly:true,value:a.eofyStart})))}).insert({bottom:new Element("span",{"class":"inlineblock half"}).update(a.me._getRowDiv("End:",new Element("input",{"class":"inputbox roundcorner datepicker",editdiv:"endtime",hour:"23:59:59",placeholder:"End of the financial year",readonly:true,value:a.eofyEnd})))})}).insert({bottom:a.me._getRowDiv("Comments: ",new Element("input",{"class":"inputbox roundcorner",editdiv:"comments",placeholder:"Comments against this financial year",value:a.eofyComments}))}).insert({bottom:new Element("div").update(new Element("fieldset",{"class":"filewrapper roundcorner",editdiv:"assets"}).update(new Element("legend").update("Attach Files:")).insert({bottom:new Element("div",{"class":"assets"}).update(a.me._getAssetListDiv(a.assets))}).insert({bottom:new Element("div",{id:a.attachmentDivID,"class":"attachmentlist",editdiv:"attachements"})}))}).insert({bottom:new Element("div",{"class":"editbtns"}).insert({bottom:new Element("input",{type:"button",value:"save"}).observe("click",function(){a.me._submitEofy(this)})}).insert({bottom:new Element("input",{type:"button",value:"Cancel"}).observe("click",function(){$(this).up(".editDiv").remove()})})});return a.div},_getAssetListDiv:function(b){var a={};a.div=new Element("div",{"class":"assets uploadedFileList",transinfo:"assets"});b.each(function(c){a.div.insert({bottom:new Element("div",{"class":"uploadedfile",assetkey:c.assetKey}).update(c.filename).insert({bottom:new Element("span",{"class":"delFile"}).update("x").observe("click",function(){if(!confirm("Are you sure you want to delete this asset?")){return}$(this).up(".uploadedfile").hide().writeAttribute("delete",true)})})})});return a.div},_submitEofy:function(b){var a={};a.me=this;a.editDiv=$(b).up(".editDiv");a.eofy={id:a.editDiv.readAttribute("eofyid")};if(a.editDiv.down('[editdiv="starttime"]')){a.eofy.start=$F(a.editDiv.down('[editdiv="starttime"]'));if(a.eofy.start.blank()){alert("Start is needed!");return}}if(a.editDiv.down('[editdiv="endtime"]')){a.eofy.end=$F(a.editDiv.down('[editdiv="endtime"]'));if(a.eofy.end.blank()){alert("End is needed!");return}}if(a.editDiv.down('[editdiv="comments"]')){a.eofy.comments=$F(a.editDiv.down('[editdiv="comments"]'))}a.eofy.attachments=a.editDiv.retrieve("fileUploader").uploadedFiles;a.btnDiv=$(b).up(".editbtns");appJs.postAjax(a.me.callbackIds.saveEOFYBtn,a.eofy,{onLoading:function(c,d){a.btnDiv.insert({top:new Element("span",{"class":"loading"}).update("Loading")}).getElementsBySelector("input[type=button]").each(function(e){e.hide()})},onComplete:function(c,f){a.btnDiv.down(".loading").remove();a.btnDiv.getElementsBySelector("input[type=button]").each(function(e){e.show()});try{a.result=appJs.getResp(f,false,true);if(!a.result.id){throw"Invalid eofy returns!"}a.eofyRow=$$("#"+a.me.listDivId+" .eofyrow[eofyid="+a.result.id+"]");if(a.eofyRow.size()>0){a.firstRow=a.eofyRow.first();a.eofyRow.first().replace(a.me._getEOFYRow(a.result,true).addClassName(a.firstRow.hasClassName("even")?"even":"odd"))}else{a.eofyRows=$$("#"+a.me.listDivId+" .eofyrow[eofyid]");if(a.eofyRows.size()>0){a.firstRow=$$("#"+a.me.listDivId+" .eofyrow[eofyid]").first();a.firstRow.insert({before:a.me._getEOFYRow(a.result,true).addClassName(a.firstRow.hasClassName("even")?"odd":"even")})}else{$$("#"+a.me.listDivId+" .eofyrow.header").first().insert({after:a.me._getEOFYRow(a.result,true).addClassName("odd")})}}a.editDiv.remove()}catch(d){alert(d)}}})},createEOFY:function(b,c){var a={};a.me=this;$$(".editDiv").each(function(d){d.remove()});a.newDiv=a.me._getEOFYDiv(c);$(a.me.listDivId).insert({top:a.newDiv});a.me.initialDatePicker("#"+a.newDiv.id+" .datepicker");a.newDiv.store("fileUploader",new FileUploaderJs(a.me.preFixAttachmentID).initFileUploader())},initialDatePicker:function(a){var b={};$$(a).each(function(c){b.hourString=c.readAttribute("hour");new Prado.WebUI.TDatePicker({ID:c,InputMode:"TextBox",Format:"yyyy-MM-dd "+b.hourString,FirstDayOfWeek:1,ClassName:"datePicker",CalendarStyle:"default",FromYear:2007,UpToYear:2030})})},getEOFYs:function(b){var a={};a.me=this;appJs.postAjax(b,{pagination:a.me.pagination},{onLoading:function(c,d){$(a.me.listDivId).update('<img src="/contents/images/loading.gif" />')},onComplete:function(c,f){try{a.result=appJs.getResp(f,false,true);a.count=a.result.size();$(a.me.listDivId).update("").insert({bottom:a.me._getEOFYRow({start:"Start",end:"End",comments:"Comments"}).addClassName("header")});if(a.count===0){alert("No EOFYs Found!");return}for(a.i=0;a.i<a.count;a.i++){a.rowNo=(pageJs.pagination.pageNumber-1)*pageJs.pagination.pageSize+a.i+1;$(a.me.listDivId).insert({bottom:a.me._getEOFYRow(a.result[a.i],true).addClassName(a.rowNo%2===0?"even":"odd")})}}catch(d){alert(d)}}})},_getEOFYRow:function(c,a){var b={};b.me=this;b.assetsDiv=new Element("div",{"class":"assetsrow uploadedFileList"});if(c.assets){c.assets.each(function(d){b.assetsDiv.insert({bottom:new Element("span",{"class":"assetlink uploadedfile",assetkey:d.assetKey}).update(d.filename).observe("click",function(){window.open("/asset/"+$(this).readAttribute("assetkey"))})})})}b.btnDiv=new Element("div",{"class":"btns inlineblock"});if(a===true){b.btnDiv.insert({bottom:new Element("div",{"class":"btn editbtn"}).update("Edit").observe("click",function(){b.me._editEOFY(this)})}).insert({bottom:new Element("div",{"class":"btn delbtn"}).update("Delete").observe("click",function(){if(!confirm("Are you sure you want to delete this EOFY?")){return}b.me._deleteEOFY(this)})})}b.div=new Element("div",{"class":"row eofyrow"}).insert({bottom:new Element("div",{"class":"content inlineblock"}).insert({bottom:new Element("div",{"class":"titlerow"}).update(new Element("span",{"class":"start inlineblock"}).update(c.start)).insert({bottom:new Element("span",{"class":"end inlineblock"}).update(c.end)}).insert({bottom:new Element("span",{"class":"comments inlineblock"}).update(c.comments)})}).insert({bottom:b.assetsDiv})}).insert({bottom:b.btnDiv}).store("eofy",c);if(a===true){b.div.writeAttribute("eofyid",(c.id?c.id:""))}return b.div},_editEOFY:function(b){var a={};a.me=this;$$(".editDiv").each(function(c){c.remove()});a.eofyRow=$(b).up(".eofyrow");a.eofy=a.eofyRow.retrieve("eofy");a.newDiv=a.me._getEOFYDiv(a.eofy).addClassName("editInLine");a.eofyRow.insert({bottom:a.newDiv});a.me.initialDatePicker("#"+a.newDiv.id+" .datepicker");a.newDiv.store("fileUploader",new FileUploaderJs(a.me.preFixAttachmentID+a.eofy.id).initFileUploader())},_deleteEOFY:function(b){var a={};a.me=this;a.row=$(b).up(".eofyrow");a.eofy=a.row.retrieve("eofy");appJs.postAjax(a.me.callbackIds.saveEOFYBtn,a.eofy,{onLoading:function(c,d){a.row.hide()},onComplete:function(c,f){try{a.result=appJs.getResp(f,false,true);if(!a.result.id){throw"Invalid eofy returns!"}a.row.remove()}catch(d){a.row.show();alert(d)}}})}};