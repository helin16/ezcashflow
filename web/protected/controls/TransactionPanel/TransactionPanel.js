var TransPaneJs=new Class.create();TransPaneJs.prototype={accountIds:{fromRootIds:[],toRootIds:[]},recentTrans:[],formDivId:"",callbackIds:{getAccounts:"",saveTrans:"",delFileCBId:""},fileUploader:null,initialize:function(b,c,d,e,a){this.formDivId=b;this.callbackIds.getAccounts=c;this.callbackIds.saveTrans=d;this.callbackIds.delFileCBId=e;this.fileUploader=new FileUploaderJs(a)},buildFrom:function(b,a){this.accountIds.fromRootIds=b;this.accountIds.toRootIds=a;this.getAccList(this.accountIds.fromRootIds,$(this.formDivId).down("[transpane=fromAccounts]"));this.getAccList(this.accountIds.toRootIds,$(this.formDivId).down("[transpane=toAccounts]"));$(this.formDivId).down("[transpane=value]").setValue("");$(this.formDivId).down("[transpane=description]").setValue("");$(this.formDivId).down("[transpane=transDate]").setValue(new Date().SimpleFormat("yyyy-MM-dd"));$(this.formDivId).down("#chk_Expense").checked=false;this.fileUploader.reset();return false},getAccList:function(b,c){var a={};if($(c).retrieve("chosen")){$(c).retrieve("chosen").destroy()}$(c).update("");a.accounts=appJs.getPageData("accounts");$H(a.accounts).each(function(d){a.rootId=d.key*1;if(b.indexOf(a.rootId)>=0){a.optGroup=new Element("optgroup",{label:a.accounts[a.rootId][a.rootId].name});a.orderedAccounts=Object.keys(d.value).map(function(e){return d.value[e]}).sortBy(function(e){return e.breadCrumbs.name});a.orderedAccounts.each(function(e){if(e.allowTrans===true){a.optGroup.insert({bottom:new Element("option",{value:e.id}).update(e.breadCrumbs.name.replace(a.rootName+" / ","")+" - $"+e.sum)})}});$(c).insert({bottom:a.optGroup})}});$(c).store("chosen",new Chosen($(c)))},stripValue:function(a){return a.strip().replace(" ","").replace("$","").replace(",","")},saveTrans:function(b,c){var a={};a.me=this;a.form=$(b).up("div.transDiv");a.fromAccListBox=a.form.down("[transpane=fromAccounts]");a.toAccListBox=a.form.down("[transpane=toAccounts]");a.valueBox=a.form.down("[transpane=value]");a.commentsBox=a.form.down("[transpane=description]");a.transDate=a.form.down("[transpane=transDate]");a.saveBtn=a.form.down("[transpane=saveBtn]");if(this.validForm(a.fromAccListBox,a.toAccListBox,a.valueBox,a.transDate)===false){return false}a.saveBtnValue=a.saveBtn.value;a.data={fromAccId:$F(a.fromAccListBox),toAccId:$F(a.toAccListBox),value:a.me.stripValue($F(a.valueBox)),comments:$F(a.commentsBox).strip(),assets:a.me.fileUploader.uploadedFiles,transDate:$F(a.transDate)};appJs.postAjax(this.callbackIds.saveTrans,a.data,{onLoading:function(d,e){a.saveBtn.value="Saving ...";a.saveBtn.disabled=true},onComplete:function(d,g){try{a.result=appJs.getResp(g,false,true);a.me.recentTrans=a.result.trans;a.me.refreshAccounts(a.result.accounts);a.me.buildFrom(a.me.accountIds.fromRootIds,a.me.accountIds.toRootIds);a.saveBtn.value=a.saveBtnValue;a.saveBtn.disabled=false;alert("Saved Successfully!");if(typeof(c)==="function"){c()}}catch(f){alert(f);a.saveBtn.value=a.saveBtnValue;a.saveBtn.disabled=false}}})},refreshAccounts:function(b){var a={};a.accounts=appJs.getPageData("accounts");$H(b).each(function(c){$H(c.value).each(function(d){a.accounts[c.key][d.value.id]=d.value})});appJs.setPageData("accounts",a.accounts)},validForm:function(d,e,c,b){var a={};a.me=this;a.succ=true;$(d).up("div.transDiv").getElementsBySelector(".errorMsg").each(function(f){f.remove()});if($F(d).blank()||$F(d)<=0){$(d).up("div.row").down("span.title").insert({bottom:new Element("span",{"class":"errorMsg"}).update("Invalid From")});a.succ=false}if($F(e).blank()||$F(e)<=0){$(e).up("div.row").down("span.title").insert({bottom:new Element("span",{"class":"errorMsg"}).update("Invalid To")});a.succ=false}a.regex=/^(\d+)(\.\d{1,2})?$/;if(!a.me.stripValue($F(c)).match(a.regex)){$(c).up(".inline").down("span.title").insert({bottom:new Element("span",{"class":"errorMsg"}).update("Invalid"+a.me.stripValue($F(c)))});a.succ=false}a.regex=/^(\d){4}-(\d){2}-(\d){2}$/;if(!a.me.stripValue($F(b)).match(a.regex)){$(b).up(".inline").down("span.title").insert({bottom:new Element("span",{"class":"errorMsg"}).update("Invalid")});a.succ=false}return a.succ},toggleFileList:function(a){if($(a).checked){this.fileUploader.initFileUploader()}else{this.fileUploader.reset()}return true}};